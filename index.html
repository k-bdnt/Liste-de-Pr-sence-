<!DOCTYPE html>
<html lang="fr" dir="ltr"> <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syst√®me de Gestion de Pr√©sence et d'Absence</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>
<div id="toast-notification"></div>

<header>
    Syst√®me de Gestion de Pr√©sence et d'Absence
    <button onclick="toggleDarkMode()" 
            style="position: absolute; left: 15px; top: 10px; 
                   background: none; border: 1px solid white; 
                   color: white; padding: 5px 10px; font-size: 1em; 
                   box-shadow: none !important; transform: none !important;">
        <i class="fas fa-moon"></i>
    </button>
</header>
<main id="main">

<div id="employees" class="tab-content-card">
    <h2>üè† Tableau de Bord (Aper√ßu)</h2>
    
    <div class="dashboard-section">
        <h3>üìä R√©sum√© du Jour <small id="currentDateDisplay" style="color: #6c757d; font-size: 0.9em; font-weight: normal;"></small></h3>
        <div class="dashboard-summary-container">
            <div class="kpi-card-dashboard green">
                <h4>Employ√©s Pr√©sents (Punch In Actif)</h4>
                <span id="kpiPresentNow" class="kpi-value-dashboard">0</span>
            </div>
            <div class="kpi-card-dashboard red">
                <h4>Absences Confirm√©es</h4>
                <span id="kpiAbsencesToday" class="kpi-value-dashboard">0</span>
            </div>
            <div class="kpi-card-dashboard yellow">
                <h4>Total des Employ√©s Enregistr√©s</h4>
                <span id="kpiTotalWorkers" class="kpi-value-dashboard">0</span>
            </div>
        </div>
    </div>
    
    <div class="dashboard-section">
        <h3>üèÉ Qui est Pr√©sent Maintenant ?</h3>
        <ul id="presenceNowList"></ul>
    </div>
    
    <div class="dashboard-section" style="margin-top: 30px;">
        <h3>‚ö†Ô∏è Actions en Attente (Enregistrements non cl√¥tur√©s)</h3>
        <p style="color: var(--danger-color);">*Enregistrements de **Punch In** non suivis d'un **Punch Out** pour les jours pr√©c√©dents.</p>
        <ul id="pendingActionsList"></ul>
    </div>
    
    <hr style="margin-top: 30px; margin-bottom: 30px;">
    
    <h2>üìã Gestion des Employ√©s et des Jours F√©ri√©s</h2>
    <p style="border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">**Liste et Gestion des Employ√©s:**</p>
    <div class="input-group" style="display: block;">
        <input type="text" id="workerName" placeholder="Nom Complet de l'Employ√©">
        <input type="text" id="workerDepartment" placeholder="D√©partement / Branche">
        <div class="input-group" style="margin-top: 5px;">
             <div><label for="defaultEntry">Entr√©e par d√©faut:</label><input type="time" id="defaultEntry" value="09:00"></div>
            <div><label for="defaultExit">Sortie par d√©faut:</label><input type="time" id="defaultExit" value="17:00"></div>
        </div>
        <button onclick="addWorker()" style="margin-top: 5px; background-color: var(--primary-color);">Ajouter Employ√©</button>
    </div>
    <ul id="workerList" style="list-style-type: none; padding: 0;"></ul>
    <p style="border-bottom: 1px dashed var(--border-color); padding: 15px 0 10px 0; margin-top: 20px;">**Gestion des Jours F√©ri√©s et √âv√©nements:**</p>
    <div class="input-group" style="display: block;">
        <input type="date" id="holidayDate" style="margin-bottom: 5px;">
        <input type="text" id="holidayName" placeholder="Nom de l'√âv√©nement (ex: F√™te de l'Ind√©pendance)">
        <button onclick="addHoliday()" style="margin-top: 5px; background-color: #555;">Ajouter √âv√©nement / Jour F√©ri√©</button>
    </div>
    <ul id="holidayList" style="list-style-type: none; padding: 0;"></ul>
</div>

<div id="register" class="tab-content-card hidden">
    <h2>‚úçÔ∏è Enregistrement de Pr√©sence et d'Absence</h2>
    
    <div class="quick-register-card">
        <h3>‚ö° Enregistrement Rapide (Punch In / Punch Out)</h3>
        
        <div class="custom-select-container" id="quickSelectContainer">
            <button id="customQuickSelectButton" class="custom-select-button" onclick="toggleWorkerDropdown('quick')">
                <span id="selectedWorkerCount">-- S√©lectionner 0 employ√©(s) --</span>
                <i class="fas fa-caret-down"></i>
            </button>
            <div id="customQuickWorkerSelectDropdown" class="custom-select-dropdown hidden" onmouseleave="closeWorkerDropdown('quick')"></div>
        </div>
        
        <textarea id="taskNoteQuick" placeholder="T√¢che(s) Accomplie(s) / Note (Optionnel)"></textarea>
        <div class="input-group" style="justify-content: space-between; gap: 10px;">
            <button onclick="quickPunch('in')" style="flex: 1; background-color: var(--success-color);"><i class="fas fa-arrow-circle-right"></i> Entr√©e (Punch In)</button>
            <button onclick="quickPunch('out')" style="flex: 1; background-color: var(--danger-color);"><i class="fas fa-arrow-circle-left"></i> Sortie (Punch Out)</button>
        </div>
        <p style="font-size: 0.9em; color: var(--secondary-color); margin-top: 15px;">L'heure actuelle est enregistr√©e automatiquement.</p>
    </div>
    <div style="margin-top: 25px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
        <h3>R√©sum√© des Enregistrements Rapides du Jour:</h3>
        <ul id="quickSummaryList" style="list-style-type: none; padding: 0;"></ul>
    </div>
    <hr style="margin-top: 30px; margin-bottom: 30px;">
    <div class="manual-register-section">
        <h3>üï∞Ô∏è Enregistrement Manuel ou R√©troactif</h3>
        <div class="input-group">
            <div><label for="workerSelect">Employ√©:</label><select id="workerSelect"><option value="" disabled selected>-- Choisir --</option></select></div>
            <div><label for="dateSelect">Date:</label><input type="date" id="dateSelect"></div>
        </div>
        <div class="input-group">
            <div><label for="entryTime">Heure d'Entr√©e:</label><input type="time" id="entryTime"></div>
            <div><label for="exitTime">Heure de Sortie:</label><input type="time" id="exitTime"></div>
        </div>
        <div class="input-group">
            <div><label for="breakStart">D√©but Pause (Opt.):</label><input type="time" id="breakStart"></div>
            <div><label for="breakEnd">Fin Pause (Opt.):</label><input type="time" id="breakEnd"></div>
        </div>
        <textarea id="manualNote" placeholder="Note sp√©ciale pour cet enregistrement (Optionnel)"></textarea>
        <button id="registerButton" onclick="registerPresence()">Enregistrer la Pr√©sence</button>
        <button onclick="clearForm()" style="background-color: #6c757d; margin-top: 5px;">Annuler / Nouveau Formulaire</button>
    </div>
    <hr style="margin-top: 30px; margin-bottom: 30px;">
    <div class="absence-section">
        <h3>‚ùå Gestion des Absences et Cong√©s (Planifi√©s)</h3>
        <div class="input-group">
            <div><label for="absenceWorker">Employ√©:</label><select id="absenceWorker"><option value="" disabled selected>-- Choisir --</option></select></div>
            <div><label for="absenceReason">Raison:</label><select id="absenceReason">
                <option value="Maladie">Maladie</option><option value="Permission">Permission</option>
                <option value="Conge_Annuel">Cong√© Annuel</option><option value="Autre">Autre</option>
            </select></div>
        </div>
        <p style="margin-top: 15px; margin-bottom: 5px;">**P√©riode d'Absence:**</p>
        <div class="input-group">
            <div><label for="startDate">Date de D√©but:</label><input type="date" id="startDate"></div>
            <div><label for="endDate">Date de Fin (M√™me date pour un jour):</label><input type="date" id="endDate"></div>
        </div>
        <button onclick="registerPlannedAbsence()" style="background-color: var(--danger-color);">Enregistrer / Planifier l'Absence</button>
        <p style="margin-top: 25px; border-top: 1px dashed var(--border-color); padding-top: 10px;">**Absences Planifi√©es:**</p>
        <ul id="plannedAbsenceList" style="list-style-type: none; padding: 0;"></ul>
    </div>
</div>

<div id="table" class="tab-content-card hidden">
    <h2>üìä Tableau des Enregistrements</h2>
    
    <div class="filter-controls">
        <h3><i class="fas fa-filter"></i> Filtres du Tableau</h3>
        
        <div class="filter-group period-filters">
            <label style="margin-right: 15px;">Filtrer par P√©riode:</label>
            <div class="period-filter-dropdown-container">
                 <button id="periodFilterButton" onclick="togglePeriodDropdown()">
                    <i class="fas fa-calendar-alt"></i> 
                    <span id="currentPeriodLabel">Toute P√©riode</span> 
                    <i class="fas fa-caret-down"></i>
                 </button>
                 <div id="periodFilterDropdown" class="hidden">
                    <div class="period-filter-option" data-filter="today" onclick="selectPeriodFilter('today')"><i class="fas fa-calendar-day" style="color:var(--success-color);"></i> Aujourd'hui</div>
                    <div class="period-filter-option" data-filter="week" onclick="selectPeriodFilter('week')"><i class="fas fa-calendar-week" style="color:#ffc107;"></i> Cette Semaine</div>
                    <div class="period-filter-option" data-filter="month" onclick="selectPeriodFilter('month')"><i class="fas fa-calendar-alt" style="color:var(--primary-color);"></i> Ce Mois</div>
                    <div class="period-filter-option active" data-filter="all" onclick="selectPeriodFilter('all')"><i class="fas fa-infinity" style="color:var(--secondary-color);"></i> Toute P√©riode</div>
                 </div>
            </div>
        </div>

        <div class="filter-group" style="display: block;">
            <label style="display: block; margin-bottom: 5px; margin-top: 10px;">Filtrer par Employ√©s:</label>
            <div class="custom-select-container" id="tableSelectContainer">
                <button id="customTableSelectButton" class="custom-select-button" onclick="toggleWorkerDropdown('table')">
                    <span id="selectedTableWorkerCount">-- Tous les employ√©s (0) --</span>
                    <i class="fas fa-caret-down"></i>
                </button>
                <div id="customTableWorkerSelectDropdown" class="custom-select-dropdown hidden" onmouseleave="closeWorkerDropdown('table')"></div>
            </div>
        </div>
    </div>

    <div class="sort-controls">
        <h3><i class="fas fa-sort"></i> Options de Tri</h3>
        <div class="sort-filter-dropdown-container">
            <button id="sortFilterButton" onclick="toggleSortDropdown()">
                <span id="currentSortLabel">Date (Plus R√©cent)</span>
                <i class="fas fa-caret-down"></i>
            </button>
            <div id="sortFilterDropdown" class="hidden">
                 <div class="sort-filter-option active" data-column="date" data-direction="desc" onclick="selectSortOption('date', 'desc', 'Date (Plus R√©cent)')"><i class="fas fa-sort-numeric-down"></i> Date (Plus R√©cent)</div>
                 <div class="sort-filter-option" data-column="date" data-direction="asc" onclick="selectSortOption('date', 'asc', 'Date (Plus Ancien)')"><i class="fas fa-sort-numeric-up"></i> Date (Plus Ancien)</div>
                 <div class="sort-filter-option" data-column="hours" data-direction="desc" onclick="selectSortOption('hours', 'desc', 'Heures Nettes (Max)')"><i class="fas fa-sort-amount-down" style="color: var(--success-color);"></i> Heures Nettes (Max)</div>
                 <div class="sort-filter-option" data-column="hours" data-direction="asc" onclick="selectSortOption('hours', 'asc', 'Heures Nettes (Min)')"><i class="fas fa-sort-amount-up" style="color: var(--success-color);"></i> Heures Nettes (Min)</div>
            </div>
        </div>
    </div>

    <div class="table-container"> 
        <table id="presenceTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Nom</th>
                    <th>D√©partement</th>
                    <th>Entr√©e</th>
                    <th>Sortie</th>
                    <th>Pause (min)</th>
                    <th>H. Nettes</th>
                    <th>Statut</th>
                    <th>Note</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="calendar" class="tab-content-card hidden">
    <h2>üìÖ Calendrier de Pr√©sence (Cliquez sur un jour pour les d√©tails)</h2>
    <select id="calendarWorker" onchange="drawCalendar(currentYear, currentMonth)"><option value="all">Tous les employ√©s</option></select>
    <div class="calendar-controls">
        <button onclick="prevMonth()" style="width: auto; background-color: #555;"><i class="fas fa-chevron-right"></i> Pr√©c√©dent</button>
        <h3 id="monthYearDisplay"></h3>
        <button onclick="nextMonth()" style="width: auto; background-color: #555;">Suivant <i class="fas fa-chevron-left"></i></button>
    </div>
    <div id="calendarDisplay" class="calendar month-view"></div>
</div>

<div id="reports" class="tab-content-card hidden">
    <h2>üìà Analyse, Rapports et Indicateurs Cl√©s (KPIs)</h2>
    <p>S√©lectionnez un employ√© ou "Tous" pour filtrer les rapports:</p>
    <select id="reportsWorkerSelect" onchange="calculateKPIs(); drawChart();">
        <option value="all">Tous les employ√©s</option>
    </select>
    
    <div class="kpi-container" style="margin-top: 25px;">
        <div class="kpi-card">
            <h4>Taux d'Absence Global (Mensuel)</h4>
            <span id="kpiAbsenceRate" class="kpi-value">--%</span>
        </div>
        <div class="kpi-card">
            <h4>Moyenne H. Nettes/Jour (Mensuel)</h4>
            <span id="kpiAvgHours" class="kpi-value">-- H</span>
        </div>
        <div class="kpi-card">
            <h4>Total H. Nettes (Mensuel)</h4>
            <span id="kpiTotalHoursMonth" class="kpi-value">-- H</span>
        </div>
    </div>
    
    <h3 style="margin-top: 30px;">R√©sum√© de Performance Mensuelle par Employ√©</h3>
    <div class="table-container">
        <table id="monthlyReportTable" style="width: 100%;">
            <thead>
                <tr>
                    <th>Employ√©</th>
                    <th>Total Heures (Mensuel)</th>
                    <th>Jours d'Absence</th>
                    <th>Moyenne Retard Entr√©e</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h3 style="margin-top: 30px;">Graphique des Heures de Travail par Employ√©</h3>
    <canvas id="hoursChart" style="margin-top: 10px;"></canvas>
</div>

<div id="profile" class="tab-content-card hidden">
    <h2>üë§ D√©tails et Modification du Profil</h2>
    <p>S√©lectionnez un employ√© pour afficher/modifier ses informations:</p>
    <select id="profileWorkerSelect" onchange="loadWorkerProfile()"><option value="" disabled selected>Choisir un employ√©</option></select>
    
    <div id="workerProfileDetails" class="profile-details-card hidden" style="border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-top: 15px; background-color: color-mix(in srgb, var(--card-bg), #000 5%);">
        
        <h3 style="margin-top: 15px;">‚öôÔ∏è Informations de Base</h3>
        <label for="editName">Nom Complet:</label>
        <input type="text" id="editName" placeholder="Nouveau Nom">
        
        <label for="editDept">D√©partement:</label>
        <input type="text" id="editDept" placeholder="Nouveau D√©partement">
        
        <div class="input-group">
            <div><label for="editEntry">Entr√©e par d√©faut:</label><input type="time" id="editEntry"></div>
            <div><label for="editExit">Sortie par d√©faut:</label><input type="time" id="editExit"></div>
        </div>
        
        <button onclick="saveWorkerProfile()" style="background-color: var(--success-color); margin-top: 15px;"><i class="fas fa-save"></i> Sauvegarder les Modifications</button>

        <hr style="margin: 30px 0;">
        
        <h3 style="margin-top: 0;">üéØ Performance Mensuelle</h3>
        
        <div class="profile-kpi-container">
            <div class="profile-kpi-card">
                <h4><i class="fas fa-hourglass-half profile-icon" style="color:var(--primary-color);"></i> Total H. Nettes</h4>
                <span id="profileTotalHours" class="profile-value">0.00 H</span>
            </div>
            <div class="profile-kpi-card">
                <h4><i class="fas fa-calendar-times profile-icon" style="color:var(--danger-color);"></i> Jours d'Absence (Nets)</h4>
                <span id="profileAbsenceDays" class="profile-value">0</span>
            </div>
             <div class="profile-kpi-card">
                <h4><i class="fas fa-stopwatch profile-icon" style="color:#FFC107;"></i> Jours de Retard</h4>
                <span id="profileLatenessDays" class="profile-value">0</span> 
            </div>
        </div>

        <hr style="margin: 30px 0;">

        <h3 style="margin-top: 0;">üìà Analyse de Pr√©sence (Mois Actuel)</h3>
        <div style="width: 100%; max-width: 300px; margin: 15px auto;">
            <canvas id="profileAttendanceChart"></canvas>
        </div>
    </div>
</div>

<div id="export" class="tab-content-card hidden">
    <h2>üíæ Exportation et Sauvegarde</h2>
    <p>Utilisez ces boutons pour sauvegarder vos donn√©es ou les exporter au format Excel (.xlsx).</p>
    <button onclick="exportDataToExcel('all')" style="background-color: #1e7e34;"><i class="fas fa-file-excel"></i> Exporter Tous les Enregistrements (Excel)</button>
    <p style="margin-top: 20px;">**Sauvegarde (Backup) des Donn√©es et Param√®tres:**</p>
    <button onclick="backupData()" style="background-color: #555;"><i class="fas fa-cloud-download-alt"></i> Sauvegarde (T√©l√©charger JSON)</button>
    <p style="margin-top: 20px;">**Restauration des Donn√©es:**</p>
    <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px;">
    <button onclick="restoreData()" style="background-color: var(--danger-color);"><i class="fas fa-upload"></i> Restaurer (Importer JSON)</button>
</div>

</main>

<div class="tab-navigation">
    <button class="tab-button active" onclick="openTab(event, 'employees')"><i class="fas fa-home"></i> Accueil</button>
    <button class="tab-button" onclick="openTab(event, 'register')"><i class="fas fa-sign-in-alt"></i> Enregistrement</button>
    <button class="tab-button" onclick="openTab(event, 'table')"><i class="fas fa-list-alt"></i> Tableau</button>
    <button class="tab-button" onclick="openTab(event, 'calendar')"><i class="fas fa-calendar-alt"></i> Calendrier</button>
    <button class="tab-button" onclick="openTab(event, 'reports')"><i class="fas fa-chart-line"></i> Rapports</button>
    <button class="tab-button" onclick="openTab(event, 'profile')"><i class="fas fa-user-circle"></i> Profil</button>
    <button class="tab-button" onclick="openTab(event, 'export')"><i class="fas fa-file-export"></i> Exporter</button>
</div>

<div id="dayDetailsModal" class="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h3 id="modalDateTitle"></h3>
        <p style="font-weight: bold;" id="modalHolidayInfo"></p>
        <hr>
        <h4>D√©tails de Pr√©sence/Absence:</h4>
        <ul id="modalDetailsList" style="list-style-type: none; padding: 0;"></ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="script.js"></script>

</body>
</html>
